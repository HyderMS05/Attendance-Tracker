<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Attendance Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; @apply bg-gray-100 text-gray-800; }
        th { @apply cursor-pointer hover:bg-gray-200; }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800">Admin Dashboard</h1>
            <p class="text-lg text-gray-600 mt-2">All Student Attendance Data</p>
        </header>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <p class="text-xl text-gray-500">Authenticating and fetching data...</p>
        </div>

        <!-- Users Table Container -->
        <div id="users-container" class="hidden max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">Registered Students</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th data-sort="name" class="p-3 font-bold uppercase text-gray-600 border-b">Full Name</th>
                            <th data-sort="rollNo" class="p-3 font-bold uppercase text-gray-600 border-b">Roll No.</th>
                            <th data-sort="academicYear" class="p-3 font-bold uppercase text-gray-600 border-b">Year</th>
                            <th class="p-3 font-bold uppercase text-gray-600 border-b">Modules Tracked</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- User rows will be inserted here -->
                    </tbody>
                </table>
            </div>
             <p id="no-users-message" class="text-center text-gray-500 py-8 hidden">No student data found.</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCqp8JwulU8UlKVBEtu3Ii9ZXeSxuF77cE",
          authDomain: "dmc-attendance-tracker.firebaseapp.com",
          projectId: "dmc-attendance-tracker",
          storageBucket: "dmc-attendance-tracker.appspot.com",
          messagingSenderId: "909390065505",
          appId: "1:909390065505:web:3a06b8be1d11ff5a719f20",
          measurementId: "G-XZBH5S7DHS"
        };
        
        const adminEmail = "hydermirzashaheer@gmail.com";
        const adminPassword = "Attendance21602";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allUsersData = [];
        let currentSort = { key: 'name', order: 'asc' };

        async function signInAndFetchData() {
            const loadingState = document.getElementById('loading-state');
            try {
                // 1. Sign in as admin
                await signInWithEmailAndPassword(auth, adminEmail, adminPassword);
                console.log("Admin signed in successfully");

                // 2. Fetch all data directly from Firestore
                loadingState.textContent = 'Fetching student data...';
                const querySnapshot = await getDocs(collection(db, "users"));
                
                querySnapshot.forEach((doc) => {
                    allUsersData.push(doc.data());
                });

                // 3. Display the data
                loadingState.classList.add('hidden');
                document.getElementById('users-container').classList.remove('hidden');
                if(allUsersData.length > 0) {
                    sortData(currentSort.key); // Initial sort
                } else {
                    document.getElementById('no-users-message').classList.remove('hidden');
                }

            } catch (error) {
                console.error("Process failed:", error);
                loadingState.innerHTML = `<p class="text-xl text-red-500">Authentication or Data Fetch Failed. Check credentials and Firestore rules.</p>`;
            }
        }

        function sortData(key) {
            if (currentSort.key === key) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.order = 'asc';
            }

            allUsersData.sort((a, b) => {
                const valA = a[key] ? a[key].toString().toLowerCase() : '';
                const valB = b[key] ? b[key].toString().toLowerCase() : '';
                
                if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        function renderTable() {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            allUsersData.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 border-b';
                
                const modulesCount = user.modules ? user.modules.length : 0;

                row.innerHTML = `
                    <td class="p-3">${user.name || 'N/A'}</td>
                    <td class="p-3">${user.rollNo || 'N/A'}</td>
                    <td class="p-3">${user.academicYear || 'N/A'}</td>
                    <td class="p-3">${modulesCount}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        document.querySelectorAll('th').forEach(th => {
            th.addEventListener('click', () => {
                const sortKey = th.dataset.sort;
                if (sortKey) {
                    sortData(sortKey);
                }
            });
        });

        // --- Initial Load ---
        signInAndFetchData();

    </script>
</body>
</html>
